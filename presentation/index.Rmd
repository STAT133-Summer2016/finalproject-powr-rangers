---
title       : Housing Affordability Over the Years
subtitle    : An Exploration into America's Housing Sector
author      : Nikolai, William, Sri, Lamb
job         : 
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : []            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---

```{r, echo = F, message = F}

library(ggplot2)
library(dplyr)
library(readr)
library(stringr)
library(xml2)
library(rvest)
library(tidyr)
library(purrr)
library(scales)
library(maps)
library(ggthemes)

```

```{r, echo = F}

clean_years <- read_csv("..//clean_years.csv")
regionNames = c("1" = "Northeast", "2" = "Midwest", "3" = "South", "4" = "West")

```


## Introduction: Motivation and Dataset

* Our data extends from 

* William's cleaning
* Sri's cleaning
* Plots
* Conclusion stuff


---


## Cleaning the Data


* 




---



## Variables 

Variables According to the HUD Document Data Set

Variables  | Meanings
---------- | --------
Burden | Householdâ€™s monthly housing cost divided by its monthly income
Per | Household Size 
ABLMED | Median Income Adjusted for # of Bedrooms
APLMED | Median Income Adjusted for # of Persons
ZSMHC | Monthly housing costs
ZINC2 | Household Income
Assisted | Asssisted Housing
Year | The Year of the Data
Region | Census Region
fmtincrelpovcat |HH Income Relative to Poverty Income 
fmtstructuretype | Structure Type
increlamipct | HH Income relative to AMI (Percent)
fmtcostmedrelamicat | CostMed Relative to Median Income 

---

## Household Income and Burden

```{r}

clean_years %>% 
  select(zinc2, year, region, fmtburden)%>% 
  filter(fmtburden != ".", fmtburden != "4 No Income") %>% 
  mutate(fmtburden = str_replace(fmtburden, "Greater than 50%", "50% or More")) %>% 
  group_by_("year", "fmtburden") %>%  
  summarise_(new_y = as.formula(
  paste0("~ median(","zinc2", ",na.rm=T)"))) %>% 
  
  
  ggplot(aes_string(x = "year", y = "new_y", color = "fmtburden")) + 
  geom_line(size = 1) + 
  labs(title = "Relationship between Household \nIncome and Burden", 
       y = "Household Income", x = "Year", color = "Burden") +
  scale_y_continuous(limits=c(0,NA),breaks=c(0,20000,40000,60000),labels=function(x){paste0(x/1000, "K")}) +
  scale_colour_brewer(palette = "Dark2") +
  theme_tufte()

```

---

## Monthly Housing Costs and Burden 


```{r, echo = F, fig.align = 'center', fig.width = 12}

cleanyearsmonthly <- clean_years %>% 
  select(year, zsmhc, region, fmtburden) %>% 
  filter(fmtburden != ".") %>% 
  mutate(fmtburden = str_replace(fmtburden, "Greater than 50%", "50% or More"))

####overall graph
cleanyearsmonthly %>%  
  group_by_("year", "fmtburden") %>%  
  summarise_(new_y = as.formula(
    paste0("~ median(","zsmhc", ",na.rm=T)"))) %>% 
  
  ggplot(aes_string(x = "year", y = "new_y", color = "fmtburden")) + 
  geom_line(size = 1) + 
  labs(title = "Relationship between Monthly \nHousing Costs and Burden", 
       y = "Monthly Housing Costs ($)", x = "Year", color = "Burden") +
  scale_colour_brewer(palette = "Dark2") +
  theme_tufte(base_size = 20)



```

---

## Regional Monthly Housing Costs and Burden

```{r}

  cleanyearsmonthly %>%  
  group_by_("year","region", "fmtburden") %>%  
  summarise_(new_y = as.formula(
    paste0("~ median(","zsmhc", ",na.rm=T)"))) %>% 
  ggplot(aes_string(x = "year", y = "new_y", color = "fmtburden")) + 
  geom_line(size = 1) + 
  facet_wrap(~region, labeller = as_labeller(regionNames)) + 
  labs(title = "Relationship between Monthly \nHousing Costs and Burden", 
       y = "Monthly Housing Costs ($)", x = "Year", color = "Burden") +
  scale_colour_brewer(palette = "Dark2") +
  theme_tufte()


```

---

## Median Income Among Differing Census Regions in 2013

```{r, echo = F, fig.align = 'center', fig.width = 12, message = F}

url <- "http://www.mapsofworld.com/usa/usa-maps/united-states-regional-maps.html"
html <- read_html(url)
xpath <- '//table[@class="tableizer-table"]'

regions_tbl <- html %>% 
  html_nodes(xpath = xpath) %>%
  html_table %>%
  .[[1]] 

region_1 <- regions_tbl[2:7,] %>% 
  gather(key = region, value = state, 1:2) %>% 
  slice(1:9) %>%
  mutate(region = 1)
  
region_2 <- regions_tbl[10:15,] %>% 
  gather(key = region, value = state, 1:2) %>% 
  mutate(region = 2)

# Add missing Missouri
region_2[6, 2] <- "Missouri"

region_3 <- regions_tbl[18:27,] %>%  
  gather(key = region, value = state, 1:2) %>% 
  slice(c(-10, -15, -16)) %>%
  mutate(region = 3)

region_4 <- 
  regions_tbl[30:37,] %>%  
  gather(key = region, value = state, 1:2) %>% 
  slice(1:13) %>%
  mutate(region = 4)

regions <- rbind(region_1, region_2, region_3, region_4) %>%
  mutate(state = str_to_title(state),
         region = as.character(region))

median_incomes <- clean_years %>%
  filter(year = 2013) %>%
  mutate(region = as.character(region)) %>%
  group_by(region) %>%
  summarise(zinc2_median = median(zinc2, na.rm = T))

map_df <- map_data("state") %>%
  mutate(region = str_to_title(region)) %>%
  rename(state = region)  %>%
  # Join with census region information
  left_join(regions) %>%
  left_join(median_incomes)
  

map_df %>% 
  ggplot() +  
  geom_polygon(aes(x=long, 
                   y = lat, 
                   fill = zinc2_median, 
                   group = group)) + 
  coord_fixed(1.3) +
  theme_tufte() +
  scale_x_continuous(name = NULL,
                     labels = NULL,
                     breaks = NULL) +
  scale_y_continuous(name = NULL,
                     labels = NULL,
                     breaks = NULL) +
  labs(fill = "Median income") +
  scale_fill_distiller(limits = c(25000, 42000), 
                                 breaks = sort(unique(map_df$zinc2_median),
                                               decreasing = T),
                                 palette = "Greens", 
                                 direction = 1,
                                 guide = "legend",
                        labels=function(x){paste0("$",x %/% 100 / 10, "K")})

```

--- 

## Household Size and Burden


```{r, echo = F}

  clean_years %>%
    mutate(per = cut(per, 
                     breaks = c(0, 1, 2, Inf),
                     labels = c("1", "2", "3 or more")))  %>%
    group_by(year, per) %>%  
    # Take the median instead of mean to avoid extreme observations skewing the 
    # result.
    summarise(new_y = median(burden, na.rm = T)) %>%
    ggplot(aes(x = year,   
                      y = new_y,   
                      colour = per)) +  
    geom_line(size = 1) +
    labs(colour = "Household Size",
         x = "Year",
         y = "Median Burden",
         title = "Relationship between Burden and Household Size") +
    scale_colour_brewer(palette = "Dark2") +
  scale_y_continuous(labels=function(x){paste0(x*100, "%")}) +
    theme_tufte()

```


---

## Households and Poverty 

```{r, echo = F, fig.align = 'center', fig.width = 12}
clean_years %>% 
  # Group and summarise the amount of people in each poverty group each year
  group_by(fmtincrelpovcat, year) %>%
  summarise(count = n()) %>%
  # Clean NAs
  na.omit() %>%
  # Group again by year to calculate relative percentages per year
  group_by(year) %>% 
  mutate(percent = count / sum(count),  
         # Clean the labels
         fmtincrelpovcat = factor(fmtincrelpovcat, 
                                  levels = c("1 LTE Poverty", 
                                             "2 100-150% Poverty", 
                                             "3 150-200% Poverty", 
                                             "4 200%+ Poverty"),  
                                  labels = c("Less than poverty income",   
                                             "100-150% of poverty income",   
                                             "150-200% of poverty income",    
                                             "> 200% of poverty income"),
                                  ordered = T)) %>% 
  ggplot(aes(x = year, 
             y = percent,
             fill = fmtincrelpovcat)) + 
  geom_area(alpha = 0.8) +
  # Use a nice colour palette
  scale_fill_brewer(palette = "RdYlGn", 
                    # Reverse the order of legend items to match the
                    # stacking order
                    guide = guide_legend(reverse=TRUE)) +
  labs(title = "Number of Households Relative to the Poverty Line",
       x = "Year",
       y = "Percent of Households",
       fill = "Household Income \nRelative to Poverty Income") +
  scale_y_continuous(labels=function(x){paste0(x*100, "%")}) +
  scale_colour_brewer(palette = "Dark2") +
  theme_tufte()
```


---


## MORE GRAPHS

```{r, echo = F, fig.align = 'center', fig.width = 12}


clean_years %>% 
  select(zinc2, year, region, fmtburden)%>% 
  filter(fmtburden != ".", fmtburden != "4 No Income") %>% 
  mutate(fmtburden = str_replace(fmtburden, "Greater than 50%", "50% or More")) %>% 
  group_by_("year", "fmtburden") %>%  
  summarise_(new_y = as.formula(
  paste0("~ median(","zinc2", ",na.rm=T)"))) %>% 
  
  
  ggplot(aes_string(x = "year", y = "new_y", color = "fmtburden")) + 
  geom_line(size = 1) + 
  labs(title = "Relationship between Household \nIncome and Burden", 
       y = "Household Income", x = "Year", color = "Burden") +
  scale_y_continuous(limits=c(0,NA),breaks=c(0,20000,40000,60000),labels=function(x){paste0(x/1000, "K")}) +
  scale_colour_brewer(palette = "Dark2") +
  theme_tufte()


```


---



## Concluding Thoughts

* Housing Affordability Has Decreased

* The 2007 Housing Bubble Crisis 

* Different Housing Regions Affected Differently 
  
  * Western and Northeast Regions Vs. South and Midwest

---


## Future Questions 

* Does the Data in some graphs keep showing a downward slope? 

* If we analyzed data from 2013 - 2016, would it show another potential, housing housing bubble?

* Our data is limited to 2013, so what is the housing situation most recently?


---

## Ask Us Anything



---

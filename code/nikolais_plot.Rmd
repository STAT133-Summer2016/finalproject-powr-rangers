---
output: html_document
---
```{r, include=F}
library(ggplot2)
library(dplyr)
library(readr)
library(stringr)
library(xml2)
library(rvest)
library(tidyr)
library(purrr)
library(maps)
```

```{r, echo=F}
col_types <- "cicciiciiciiidicidicddddddiidddddddddddddddddididididididididididididididicccccccccccccccccccccccccd"
 
clean_years <- read_csv("../data/clean_years.csv", col_types = col_types)

  clean_years %>%
    mutate(per = cut(per, 
                     breaks = c(0, 1, 2, Inf),
                     labels = c("1", "2", "3 or more")))  %>%
    group_by(year, per) %>%  
    # Take the median instead of mean to avoid extreme observations skewing the 
    # result.
    summarise(new_y = median(burden, na.rm = T)) %>%
    ggplot(aes(x = year, 
               y = new_y,
               colour = per)) +  
    geom_line() +
    labs(colour = "Household size",
         x = "Year",
         y = "Median burden")
```

The graph shows the development of median burden (proportion of housing costs relative to household income) from 1985 to 2013. The median burden varies dramatically between households of different sizes. The highest burden through the years has been on households of one person. This is understandable, since people living alone cannot split any costs between other earners.

Surprisingly, households of two people have the lowest burdens overall. Our hypothesis is that this is due to a large proportion of two-earner couples in this group. As housing cost burden is simply a householdâ€™s monthly housing cost divided by its monthly income, households where all members are earners have a higher monthly income and a lower resulting burden. In households of 3 or more people, the burden picks up again. This is likely due to a larger amount of children and / or retirees in larger households.

Another interesting thing is the dramatic increase of burden during the buildup to the financial crisis 2000-2007. The most probable exlanation is the housing market price bubble. Once the crisis hit in 2007, the effect of dropping incomes continued to increase burdens until 2011. Only in 2013 data did the burdens start to fall from the unprecedently high levels.


```{r, include=F}
url <- "http://www.mapsofworld.com/usa/usa-maps/united-states-regional-maps.html"
html <- read_html(url)
xpath <- '//table[@class="tableizer-table"]'

regions_tbl <- html %>% 
  html_nodes(xpath = xpath) %>%
  html_table %>%
  .[[1]] 

region_1 <- regions_tbl[2:7,] %>% 
  gather(key = region, value = state, 1:2) %>% 
  slice(1:9) %>%
  mutate(region = 1)
  
region_2 <- regions_tbl[10:15,] %>% 
  gather(key = region, value = state, 1:2) %>% 
  mutate(region = 2)

# Add missing Missouri
region_2[6, 2] <- "Missouri"

region_3 <- regions_tbl[18:27,] %>%  
  gather(key = region, value = state, 1:2) %>% 
  slice(c(-10, -15, -16)) %>%
  mutate(region = 3)

region_4 <- 
  regions_tbl[30:37,] %>%  
  gather(key = region, value = state, 1:2) %>% 
  slice(1:13) %>%
  mutate(region = 4)

regions <- rbind(region_1, region_2, region_3, region_4) %>%
  mutate(state = str_to_title(state),
         region = as.character(region))

median_incomes <- clean_years %>%
  group_by(region) %>%
  summarise(zinc2_median = median(zinc2, na.rm = T))

map_df <- map_data("state") %>%
  mutate(region = str_to_title(region)) %>%
  rename(state = region)  %>%
  # Join with census region information
  left_join(regions) %>%
  left_join(median_incomes)
  

usa_map <- map_df %>% 
  ggplot() +  
  geom_polygon(aes(x=long, 
                   y = lat, 
                   fill = zinc2_median, 
                   group = group)) + 
  coord_fixed(1.3) +
  theme_minimal() +
  scale_x_continuous(name = NULL,
                     labels = NULL,
                     breaks = NULL) +
  scale_y_continuous(name = NULL,
                     labels = NULL,
                     breaks = NULL) +
  labs(fill = "Median income") +
  scale_fill_gradient2(midpoint = 25000)

```

```{r, echo=F}
usa_map
```

To gauge income levels in different areas we used the four census regions in the dataset and joined them with a scraped table from mapsoftheworld.com. Using the table we could connect census regions to state names and thus colour a map of the continental US with census region incomes. We used median incomes instead of mean incomes to avoid skewing the results with outliers.

The household median monthly incomes vary between different census regions from 32200 dollars in the South to nearly 25% higher, 40000, in the West. The Northeast trails closely behind the West with 37267.50 dollars, and the Midwest is closer to the South with a median income of 35000.

While the dataset doesn't have more granular location data, even these four regions are very distinct from each other. The large high-income cities in the Northeast and the West likely contribute to the higher respective median incomes, while more rural Midwest and South are poorer.



